<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentMatrix</title>
    <meta name="google" content="notranslate">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.0/dist/cdn.min.js"></script>

    <!-- Tabler Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/custom.css">
</head>
<body class="bg-slate-50">
    <div id="app" x-data="app()" x-show="!isLoading">
        <!-- Loading Screen -->
        <div x-show="isLoading" class="fixed inset-0 flex items-center justify-center bg-slate-50">
            <div class="text-center">
                <div class="spinner mx-auto mb-4"></div>
                <p class="text-slate-600">Loading AgentMatrix...</p>
            </div>
        </div>

        <!-- Main Application (Warm Start) -->
        <div x-show="!isColdStart && !isLoading">
            <!-- Header with Logo and Tabs -->
            <header class="bg-white border-b border-slate-200">
                <div class="flex items-center justify-between px-6 py-3">
                    <!-- Logo -->
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-sm">
                            <i class="ti ti-robot text-white text-sm"></i>
                        </div>
                        <h1 class="text-lg font-semibold text-slate-800 tracking-tight">AgentMatrix</h1>
                    </div>

                    <!-- Tabs -->
                    <nav class="flex items-center space-x-1">
                        <button @click="switchTab('master')" :class="currentTab === 'master' ? 'bg-slate-100 text-slate-900' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-50'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                            <i class="ti ti-user mr-1.5"></i>Master
                        </button>
                        <button @click="switchTab('world')" :class="currentTab === 'world' ? 'bg-slate-100 text-slate-900' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-50'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                            <i class="ti ti-world mr-1.5"></i>World
                        </button>
                        <button @click="switchTab('settings')" :class="currentTab === 'settings' ? 'bg-slate-100 text-slate-900' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-50'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                            <i class="ti ti-settings mr-1.5"></i>Settings
                        </button>
                    </nav>

                    <!-- Right Side -->
                    <div class="w-20"></div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="h-screen" style="height: calc(100vh - 57px);">
                <!-- Master User View -->
                <div x-show="currentTab === 'master'" class="h-full bg-slate-50">
                    <div class="resizable-grid h-full" style="display: grid; grid-template-columns: 280px 1fr 280px; gap: 1px; background-color: #e2e8f0;">
                        <!-- Left: Session List -->
                        <div class="bg-white overflow-hidden flex flex-col" style="resize: horizontal; overflow: auto; min-width: 200px; max-width: 500px;">
                            <div class="px-4 py-3 border-b border-slate-200 flex justify-between items-center bg-white">
                                <h2 class="text-sm font-semibold text-slate-700">Conversations</h2>
                                <button @click="showNewEmailModal = true" class="px-3 py-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition shadow-sm text-sm font-medium">
                                    <i class="ti ti-plus mr-1"></i>New
                                </button>
                            </div>
                            <div class="flex-1 overflow-y-auto">
                                <template x-for="session in sessions" :key="session.session_id">
                                    <div @click="selectSession(session)" :class="currentSession?.session_id === session.session_id ? 'bg-blue-50' : 'hover:bg-slate-50'" class="px-4 py-3 border-b border-slate-100 cursor-pointer transition">
                                        <h3 class="text-sm font-medium text-slate-800 truncate" x-text="session.name"></h3>
                                        <p class="text-xs text-slate-500 mt-0.5" x-text="formatDate(session.last_email_time)"></p>
                                    </div>
                                </template>
                                <div x-show="sessions.length === 0" class="px-4 py-8 text-center text-slate-400 text-sm">
                                    No conversations yet
                                </div>
                            </div>
                        </div>

                        <!-- Middle: Conversation History -->
                        <div class="bg-white overflow-hidden flex flex-col">
                            <div class="px-4 py-3 border-b border-slate-200 bg-white">
                                <h2 class="text-sm font-semibold text-slate-700">Messages</h2>
                            </div>
                            <div class="flex-1 overflow-y-auto p-4 bg-slate-50">
                                <div x-show="!currentSession" class="flex items-center justify-center h-full">
                                    <p class="text-slate-400 text-sm">Select a conversation to view messages</p>
                                </div>
                                <div x-show="currentSession" class="space-y-4">
                                    <template x-for="email in currentSessionEmails" :key="email.id">
                                        <div :class="email.is_from_user ? 'ml-0 mr-8' : 'ml-8 mr-0'" class="flex">
                                            <div :class="email.is_from_user ? 'bg-blue-500 text-white' : 'bg-white text-slate-800 border border-slate-200'" class="message-bubble max-w-2xl shadow-sm">
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="text-xs font-medium opacity-75" x-text="email.sender"></span>
                                                    <span class="text-xs opacity-60" x-text="formatTime(email.timestamp)"></span>
                                                </div>
                                                <div x-show="email.subject" class="text-sm font-medium mb-2 opacity-90" x-text="email.subject"></div>
                                                <div class="text-sm leading-relaxed whitespace-pre-wrap" x-text="email.body"></div>
                                            </div>
                                        </div>
                                    </template>
                                    <div x-show="currentSessionEmails.length === 0" class="flex items-center justify-center h-full">
                                        <p class="text-slate-400 text-sm">No messages in this conversation yet</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: File View -->
                        <div class="bg-white overflow-hidden flex flex-col" style="resize: horizontal; overflow: auto; min-width: 200px; max-width: 500px;">
                            <div class="px-4 py-3 border-b border-slate-200 bg-white">
                                <h2 class="text-sm font-semibold text-slate-700">Files</h2>
                            </div>
                            <div class="flex-1 overflow-y-auto p-4 file-tree">
                                <p class="text-slate-400 text-sm text-center py-8">No files</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- World View -->
                <div x-show="currentTab === 'world'" class="h-full">
                    <div class="bg-white rounded-lg shadow p-8 text-center">
                        <i class="ti ti-world text-6xl text-slate-300 mb-4"></i>
                        <h2 class="text-xl font-semibold text-slate-800 mb-2">World View</h2>
                        <p class="text-slate-600">Agent 世界视图即将推出</p>
                    </div>
                </div>

                <!-- Matrix Settings -->
                <div x-show="currentTab === 'settings'" class="h-full">
                    <div class="bg-white rounded-lg shadow p-8 text-center">
                        <i class="ti ti-settings text-6xl text-slate-300 mb-4"></i>
                        <h2 class="text-xl font-semibold text-slate-800 mb-2">Matrix Settings</h2>
                        <p class="text-slate-600">配置管理即将推出</p>
                    </div>
                </div>
            </main>

            <!-- New Email Modal -->
            <div x-show="showNewEmailModal" class="fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm z-50" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">
                    <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                        <h2 class="text-lg font-semibold text-slate-800">New Conversation</h2>
                        <button @click="showNewEmailModal = false" class="text-slate-400 hover:text-slate-600 transition">
                            <i class="ti ti-x text-xl"></i>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="relative">
                            <label class="block text-sm font-medium text-slate-700 mb-2">To</label>
                            <input type="text" x-model="agentSearchQuery" @focus="showAgentDropdown = true" @blur="setTimeout(() => showAgentDropdown = false, 200)" placeholder="Type to filter agents..." class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                            <!-- Dropdown -->
                            <div x-show="showAgentDropdown && (filteredAgents.length > 0 || agentSearchQuery)" class="absolute z-10 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-40 overflow-y-auto">
                                <template x-for="agent in filteredAgents" :key="agent">
                                    <div @click="selectAgent(agent)" class="px-3 py-2 hover:bg-slate-50 cursor-pointer text-sm" x-text="agent"></div>
                                </template>
                                <div x-show="filteredAgents.length === 0" class="px-3 py-2 text-slate-400 text-sm">No agents found</div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Message</label>
                            <textarea x-model="newEmail.body" rows="10" placeholder="Type your message..." class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition resize-none"></textarea>
                        </div>
                    </div>
                    <div class="px-6 py-4 border-t border-slate-200 flex justify-end space-x-3 bg-slate-50">
                        <button @click="showNewEmailModal = false" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-100 transition font-medium">Cancel</button>
                        <button @click="sendEmail()" :disabled="isSendingEmail || !newEmail.recipient || !newEmail.body" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!isSendingEmail">Send</span>
                            <span x-show="isSendingEmail">Sending...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom JavaScript -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/ws.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
