# User Agent åç§°é‡æž„å¯è¡Œæ€§ç ”ç©¶

## ðŸ“‹ éœ€æ±‚åŠ¨æœº

### å½“å‰é—®é¢˜
åœ¨ AgentMatrix ç³»ç»Ÿä¸­ï¼Œ"User" agent ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„ä»£ç†è§’è‰²ï¼Œå…¶åå­—è¢«ç¡¬ç¼–ç ä¸º "User"ã€‚è¿™å¸¦æ¥ä»¥ä¸‹é™åˆ¶ï¼š

1. **ç¼ºä¹çµæ´»æ€§**ï¼šç”¨æˆ·æ— æ³•æ ¹æ®å…·ä½“åœºæ™¯è‡ªå®šä¹‰ User agent çš„åå­—
2. **å›½é™…åŒ–æ”¯æŒä¸è¶³**ï¼šéžè‹±è¯­çŽ¯å¢ƒä¸‹çš„ç”¨æˆ·ä½“éªŒè¾ƒå·®
3. **è¯­ä¹‰å•ä¸€**ï¼šåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œ"User" å¯èƒ½ä¸æ˜¯æœ€ä½³è¡¨è¾¾ï¼ˆä¾‹å¦‚ "Human"ã€"Alice" ç­‰ï¼‰
4. **æœªæ¥æ‰©å±•å—é™**ï¼šå¦‚æžœæœªæ¥éœ€è¦æ”¯æŒå¤šç”¨æˆ·æˆ–ç”¨æˆ·èº«ä»½åŒºåˆ†ï¼Œå½“å‰æž¶æž„ä¼šæˆä¸ºéšœç¢

### ç›®æ ‡
å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ User agent çš„åå­—ï¼ŒåŒæ—¶ï¼š
- âœ… ä¿æŒå…¶åœ¨ç³»ç»Ÿä¸­çš„ç‰¹æ®Šä»£ç†è§’è‰²
- âœ… ç»´æŒå‘åŽå…¼å®¹æ€§
- âœ… ä¸ç ´åçŽ°æœ‰åŠŸèƒ½
- âœ… æä¾›æ¸…æ™°çš„é…ç½®æ–¹å¼

---

## ðŸ” å½“å‰æž¶æž„åˆ†æž

### User Agent çš„å®šä¹‰å’ŒåŠ è½½

#### 1. é…ç½®æ–‡ä»¶å®šä¹‰

**ä½ç½®**: `src/agentmatrix/profiles/user_proxy.yml`

```yaml
#You should always have one USER agent
name: User
description: Master of world
module: agentmatrix.agents.user_proxy
class_name: UserProxyAgent
```

User agent é€šè¿‡ YAML é…ç½®æ–‡ä»¶å®šä¹‰ï¼ŒåŒ…å«ï¼š
- **Name**: "User"ï¼ˆç¡¬ç¼–ç ï¼‰
- **Module**: `agentmatrix.agents.user_proxy`
- **Class**: `UserProxyAgent`
- **Mixins**: FileSkillMixinï¼ˆæä¾›æ–‡ä»¶ç³»ç»Ÿæ“ä½œèƒ½åŠ›ï¼‰

#### 2. åŠ è½½æœºåˆ¶

**æ ¸å¿ƒæ–‡ä»¶**: `src/agentmatrix/core/loader.py`

`AgentLoader` ç±»è´Ÿè´£åŠ è½½æ‰€æœ‰ agentï¼š
- **ç¬¬ 179-187 è¡Œ**ï¼š`load_all()` æ–¹æ³•éåŽ†é…ç½®è·¯å¾„ä¸‹çš„æ‰€æœ‰ `.yml` æ–‡ä»¶
- ä½¿ç”¨ Python çš„ `importlib` åŠ¨æ€å¯¼å…¥
- å°†æ¯ä¸ª agent ä»¥å…¶ `name` ä¸ºé”®å­˜å‚¨åœ¨å­—å…¸ä¸­
- **åŠ è½½è¿‡ç¨‹ä¸­å¯¹ User agent æ²¡æœ‰ç‰¹æ®Šå¤„ç†** - å®ƒå’Œå…¶ä»– agent ä¸€æ ·è¢«åŠ è½½

**Runtime é›†æˆ**: `src/agentmatrix/core/runtime.py`

- **ç¬¬ 85-88 è¡Œ**ï¼šå®žä¾‹åŒ– `AgentLoader` å¹¶åŠ è½½æ‰€æœ‰ agent
- **ç¬¬ 89-90 è¡Œ**ï¼šä¸ºæ‰€æœ‰ agentï¼ˆåŒ…æ‹¬ Userï¼‰é™„åŠ å¼‚æ­¥äº‹ä»¶å›žè°ƒ
- **ç¬¬ 176-182 è¡Œ**ï¼šä»Žå¿«ç…§æ¢å¤ agent çŠ¶æ€ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
- **ç¬¬ 189-196 è¡Œ**ï¼šå‘ PostOffice æ³¨å†Œæ‰€æœ‰ agent

#### 3. User Agent å®žçŽ°

**æ–‡ä»¶**: `src/agentmatrix/agents/user_proxy.py`

`UserProxyAgent` ç±»ç»§æ‰¿è‡ª `BaseAgent`ï¼Œå…·æœ‰ç‰¹æ®ŠåŠŸèƒ½ï¼š

```python
class UserProxyAgent(BaseAgent):
    def __init__(self, name, description, config):
        super().__init__(name, description, config)
        self.on_mail_received = None  # ç¬¬13è¡Œï¼šå›žè°ƒå±žæ€§

    def set_mail_handler(self, handler):  # ç¬¬16-18è¡Œ
        """è®¾ç½®é‚®ä»¶å¤„ç†å™¨å›žè°ƒ"""
        self.on_mail_received = handler

    def process_email(self, email):  # ç¬¬20-42è¡Œ
        """å¤„ç†æ¥è‡ªå…¶ä»– agent çš„é‚®ä»¶"""
        if self.on_mail_received:
            self.on_mail_received(email)

    def speak(self, user_session_id, target, content, subject=None):  # ç¬¬43-81è¡Œ
        """ä»£è¡¨ç”¨æˆ·å‘é€é‚®ä»¶"""
        # å‘é€é‚®ä»¶å®žçŽ°...
```

---

## ðŸ“ ç¡¬ç¼–ç  "User" çš„å…¨éƒ¨ä½ç½®

### Python ä»£ç å¼•ç”¨

#### **server.py**ï¼ˆWeb æœåŠ¡å™¨ï¼‰
- **ç¬¬ 187 è¡Œ**: `if "User" in matrix_runtime.agents:` - æ£€æŸ¥ User agent æ˜¯å¦å­˜åœ¨
- **ç¬¬ 221 è¡Œ**: `matrix_runtime.agents["User"].set_mail_handler(user_mail_callback)` - è®¾ç½®é‚®ä»¶å¤„ç†å™¨
- **ç¬¬ 397 è¡Œ**: `user_agent = matrix_runtime.agents.get("User")` - èŽ·å– User agent ç”¨äºŽå‘é€é‚®ä»¶

#### **cli_runner.py**ï¼ˆå‘½ä»¤è¡ŒæŽ¥å£ï¼‰
- **ç¬¬ 35 è¡Œ**: `matrix.agents["User"].on_mail_received = print_to_console` - è®¾ç½®æŽ§åˆ¶å°è¾“å‡ºå›žè°ƒ
- **ç¬¬ 73 è¡Œ**: `await matrix.agents["User"].speak(...)` - é€šè¿‡ User agent å‘é€é‚®ä»¶
- **ç¬¬ 86 è¡Œ**: `await matrix.agents["User"].speak(user_session_id, target.strip(), content.strip())` - å‘é€æ¶ˆæ¯

#### **database.py**ï¼ˆæ•°æ®åº“æ“ä½œï¼‰
- **ç¬¬ 88 è¡Œ**: `WHERE user_session_id = ? AND (sender = 'User' OR recipient = 'User')` - è¿‡æ»¤ User ç›¸å…³é‚®ä»¶

#### **post_office.py**ï¼ˆé‚®ä»¶è·¯ç”±ï¼‰
- **ç¬¬ 235 è¡Œ**: `email.is_from_user = (email.sender == 'User')` - æ ‡è®°æ¥è‡ª User çš„é‚®ä»¶

#### **base.py**ï¼ˆAgent åŸºç±»ï¼‰
- **ç¬¬ 446 è¡Œ**: `"to": "æ”¶ä»¶äºº (e.g. 'User', 'Planner', 'Coder')"` - æ–‡æ¡£ç¤ºä¾‹

### JavaScript/Web å‰ç«¯å¼•ç”¨

#### **Web ç•Œé¢** (`web/js/app.js`)
- **ç¬¬ 79 è¡Œ**: `const filtered = rawAgents.filter(a => a !== 'User')` - ä»Ž agent åˆ—è¡¨è¿‡æ»¤ User
- **ç¬¬ 202 è¡Œ**: `if (name === 'User') return 'U'` - ä¸º User æ˜¾ç¤ºç‰¹æ®Šå¤´åƒ
- **ç¬¬ 223-226 è¡Œ**: æ³¨é‡Šå¼•ç”¨ `user_proxy` è‡ªåŠ¨ç”Ÿæˆä¸»é¢˜

#### **å®¢æˆ·ç«¯ HTML** (`client.html`)
- **ç¬¬ 161 è¡Œ**: `addLog("LOG", "User", "Task Submitted: " + task)` - è®°å½• User æ“ä½œ

### æ¨¡æ¿/é…ç½®å¼•ç”¨

#### **Prompt æ¨¡æ¿** (`profiles/prompts/base.txt` å’Œ `web/matrix_template/agents/prompts/base.txt`)
- **ç¬¬ 82 è¡Œ**: `[ACTION SIGNAL]: The recipient is 'User'.` - Prompt ç¤ºä¾‹

#### **User é…ç½®æ–‡ä»¶**
- `src/agentmatrix/profiles/user_proxy.yml` - ç¬¬ 2 è¡Œ: `name: User`
- `web/matrix_template/agents/User.yml` - ç¬¬ 2 è¡Œ: `name: User`
- `MyWorld/agents/User.yml` - ç¬¬ 2 è¡Œ: `name: User`

### æ–‡æ¡£å¼•ç”¨

#### **API æ–‡æ¡£** (`docs/dev-plan/phase1-api.md`)
- **ç¬¬ 207, 220, 265 è¡Œ**: ç¤ºä¾‹ JSON æ˜¾ç¤º `"sender": "User"` å’Œ `"recipient": "User"`
- **ç¬¬ 551 è¡Œ**: SQL è¿‡æ»¤æ³¨é‡Š: `# è¿‡æ»¤æ¡ä»¶: from='User' OR to='User'`

---

## ðŸŽ¯ User Agent çš„ç‰¹æ®Šæ€§åˆ†æž

### ç‹¬ç‰¹åŠŸèƒ½

User agent æœ‰å‡ ä¸ªåŒºåˆ«äºŽå…¶ä»– agent çš„ç‰¹å¾ï¼š

#### **1. å¤–éƒ¨æŽ¥å£ä»£ç†**
- å……å½“äººç±»ç”¨æˆ·ä¸Ž agent ç³»ç»Ÿä¹‹é—´çš„æŽ¥å£
- æ‹¥æœ‰ `on_mail_received` å›žè°ƒï¼Œå¤–éƒ¨ä»£ç å¯ä»¥è®¾ç½®
- å…¶ä»– agent **æ²¡æœ‰**è¿™ä¸ªå›žè°ƒæœºåˆ¶

#### **2. é‚®ä»¶å¤„ç†å™¨æ¨¡å¼**
- **Server**: ä½¿ç”¨ `set_mail_handler()` å°†æŽ¥æ”¶åˆ°çš„é‚®ä»¶æŽ¨é€åˆ° WebSocket å®¢æˆ·ç«¯
- **CLI**: ä½¿ç”¨ `on_mail_received` å°†é‚®ä»¶æ‰“å°åˆ°æŽ§åˆ¶å°
- å…¶ä»– agent é€šè¿‡ `process_email()` å†…éƒ¨å¤„ç†é‚®ä»¶

#### **3. UI ä¸­çš„ç‰¹æ®Šè¿‡æ»¤**
- Web ç•Œé¢ä»Ž agent åˆ—è¡¨è¿‡æ»¤ "User"ï¼ˆapp.js ç¬¬ 79 è¡Œï¼‰
- User èŽ·å¾—ç‰¹æ®Šçš„å¤´åƒæ˜¾ç¤ºï¼ˆå•å­—æ¯ "U" è€Œéž 2 å­—æ¯ï¼‰
- å¯¹è¯åŽ†å²æ˜¯ "User è§†è§’"ï¼ˆæ¥è‡ª User çš„æ¶ˆæ¯åœ¨å·¦ä¾§ï¼Œå…¶ä»–åœ¨å³ä¾§ï¼‰

#### **4. æ•°æ®åº“æŸ¥è¯¢**
- ç‰¹æ®Š SQL æŸ¥è¯¢è¿‡æ»¤ `sender = 'User' OR recipient = 'User'`
- `get_session_emails_for_user()` ä¸“é—¨æ£€ç´¢ User ç›¸å…³é‚®ä»¶
- åŸºäºŽä¸Ž "User" å­—ç¬¦ä¸²çš„æ¯”è¾ƒæ·»åŠ  `is_from_user` æ ‡å¿—

#### **5. ä¼šè¯ç®¡ç†**
- User ä¼šè¯ä¸Ž agent æ“ä½œåˆ†å¼€è·Ÿè¸ª
- æ¯ä¸ªå¯¹è¯æœ‰ `user_session_id`ï¼Œé“¾æŽ¥åˆ° User agent
- ä¼šè¯åœ¨ `user_sessions.json` ä¸­ç®¡ç†

### å…³é”®å‘çŽ°

**âš ï¸ é‡è¦**: æ²¡æœ‰**åŸºäºŽç±»åž‹çš„ç‰¹æ®Šå¤„ç†**ã€‚æ²¡æœ‰ç±»åž‹æ£€æŸ¥æˆ–æŽ¥å£å®žçŽ°æ¥åŒºåˆ† User agent å’Œå…¶ä»– agentã€‚ç‰¹æ®Šå¤„ç†å®Œå…¨åŸºäºŽ**å­—ç¬¦ä¸²åç§° "User"** åœ¨æ•´ä¸ªä»£ç åº“ä¸­è¢«ç¡¬ç¼–ç ã€‚

---

## ðŸ’¡ å®žçŽ°æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: é…ç½®åŒ–ï¼ˆæŽ¨èï¼‰

å®šä¹‰å¯é…ç½®çš„ user agent åç§°ï¼Œå¹¶å›žé€€åˆ° "User" ä»¥ä¿æŒå‘åŽå…¼å®¹ã€‚

**ä¼˜ç‚¹**:
- âœ… æœ€çµæ´»
- âœ… å‘åŽå…¼å®¹
- âœ… å•ä¸€çœŸå®žæ¥æº
- âœ… æ˜“äºŽç»´æŠ¤

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦æ·»åŠ é…ç½®æ–‡ä»¶
- âš ï¸ éœ€è¦çŽ°æœ‰ç”¨æˆ·çš„è¿ç§»æŒ‡å—

### æ–¹æ¡ˆ 2: åŠ¨æ€æ£€æµ‹

åŸºäºŽå…¶ç±»ç±»åž‹ï¼ˆ`UserProxyAgent`ï¼‰è€Œéžåç§°æ¥æ£€æµ‹ user proxy agentã€‚

**ä¼˜ç‚¹**:
- âœ… æž¶æž„ä¸Šæ›´ä¼˜é›…
- âœ… æ— éœ€é…ç½®
- âœ… è‡ªåŠ¨å·¥ä½œ

**ç¼ºç‚¹**:
- âŒ æ•°æ®åº“æŸ¥è¯¢ä»éœ€è¦å­˜å‚¨åç§°
- âŒ å®žçŽ°æ›´å¤æ‚
- âŒ å‰ç«¯ä»éœ€è¦çŸ¥é“åç§°

### æ–¹æ¡ˆ 3: ä¿ç•™ Agent å±žæ€§

åœ¨ agent YAML é…ç½®ä¸­æ·»åŠ  `is_user_proxy: true` æ ‡å¿—ã€‚

**ä¼˜ç‚¹**:
- âœ… æ˜Žç¡®æ¸…æ™°
- âœ… å¦‚éœ€è¦å…è®¸å¤šä¸ª proxy agent
- âœ… æ˜“äºŽéªŒè¯

**ç¼ºç‚¹**:
- âš ï¸ çŽ°æœ‰é…ç½®çš„ç ´åæ€§å˜æ›´
- âš ï¸ ä»éœ€è¦åœ¨æŸå¤„å­˜å‚¨åç§°

---

## ðŸŽ¯ æŽ¨èæ–¹æ¡ˆï¼šé…ç½®åŒ–è®¾è®¡

### æž¶æž„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é…ç½®å±‚ (Configuration Layer)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ matrix_world.yml (æ–°å¢ž)            â”‚ â”‚
â”‚  â”‚ user_agent_name: "Human"          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿è¡Œæ—¶å±‚ (Runtime Layer)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Runtime.USER_AGENT_NAME (å¸¸é‡)     â”‚ â”‚
â”‚  â”‚ ä½¿ç”¨è€…: Server, CLI, PostOffice    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŒä¹…åŒ–å±‚ (Persistence Layer)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ•°æ®åº“å­˜å‚¨ user agent åç§°         â”‚ â”‚
â”‚  â”‚ æŸ¥è¯¢ä½¿ç”¨åŠ¨æ€åç§°                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¡¨çŽ°å±‚ (Presentation Layer)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å‰ç«¯ä»Ž /api/config è¯»å–            â”‚ â”‚
â”‚  â”‚ åŠ¨æ€è¿‡æ»¤/æŽ’åº                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“‹ è¯¦ç»†å®žæ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒé…ç½®ï¼ˆåŽç«¯ï¼‰

#### 1.1 æ·»åŠ é…ç½®
- **æ–‡ä»¶**: `src/agentmatrix/core/config.py`ï¼ˆæ–°å»ºæˆ–æ‰©å±•çŽ°æœ‰ï¼‰
  ```python
  USER_AGENT_NAME = "User"  # é»˜è®¤å€¼ï¼Œå¯è¢«è¦†ç›–
  ```

#### 1.2 åŠ è½½é…ç½®
- **æ–‡ä»¶**: `server.py`
  - ç¬¬ 104-116 è¡Œï¼šä»Ž `matrix_world.yml` è¯»å– `user_agent_name`
  - ä¼ é€’ç»™ `AgentMatrixRuntime`

#### 1.3 æ›´æ–° Runtime
- **æ–‡ä»¶**: `src/agentmatrix/core/runtime.py`
  - åœ¨ `__init__` ä¸­æ·»åŠ  `user_agent_name` å‚æ•°
  - å­˜å‚¨ä¸º `self.user_agent_name`ï¼ˆå¸¸é‡ï¼‰
  - æ·»åŠ å±žæ€§ getter: `get_user_agent_name()`

**æ›´æ”¹**: 3 ä¸ªæ–‡ä»¶ï¼Œçº¦ 30 è¡Œä»£ç 

---

### ç¬¬äºŒé˜¶æ®µï¼šåŽç«¯å¼•ç”¨æ›´æ–°

#### 2.1 æœåŠ¡å™¨å›žè°ƒ
- **æ–‡ä»¶**: `server.py`
  - ç¬¬ 187 è¡Œï¼šå°† `if "User" in matrix_runtime.agents` æ›¿æ¢ä¸ºåŠ¨æ€æŸ¥æ‰¾
  - ç¬¬ 221 è¡Œï¼šå°† `matrix_runtime.agents["User"]` æ›¿æ¢ä¸ºåŠ¨æ€
  - ç¬¬ 397 è¡Œï¼šå°† `matrix_runtime.agents.get("User")` æ›¿æ¢ä¸ºåŠ¨æ€

**æ›´æ”¹**: ç”¨ `matrix_runtime.get_user_agent_name()` æ›¿æ¢ç¡¬ç¼–ç  "User"

#### 2.2 CLI æŽ¥å£
- **æ–‡ä»¶**: `cli_runner.py`
  - ç¬¬ 35, 73, 86 è¡Œï¼šç”¨ `matrix.get_user_agent_name()` æ›¿æ¢ "User" å­—ç¬¦ä¸²

**æ›´æ”¹**: 3 å¤„æ›¿æ¢

#### 2.3 æ•°æ®åº“æŸ¥è¯¢
- **æ–‡ä»¶**: `src/agentmatrix/core/database.py`
  - ç¬¬ 88 è¡Œï¼šå‚æ•°åŒ–æŸ¥è¯¢è€Œä¸æ˜¯ç¡¬ç¼–ç  `'User'`
  - æ›´æ–° `get_session_emails_for_user()` ä»¥æŽ¥å— user_agent_name å‚æ•°

**æ›´æ”¹**: ä½¿æŸ¥è¯¢åŠ¨æ€åŒ–ï¼Œæ·»åŠ çŽ°æœ‰æ•°æ®è¿ç§»

#### 2.4 Post Office é€»è¾‘
- **æ–‡ä»¶**: `src/agentmatrix/core/post_office.py`
  - ç¬¬ 235 è¡Œï¼šå°† `email.sender == 'User'` æ›¿æ¢ä¸ºåŠ¨æ€æ¯”è¾ƒ
  - æ›´æ–°æ‰€æœ‰è¿‡æ»¤ User é‚®ä»¶çš„æ–¹æ³•ä»¥ä½¿ç”¨ runtime çš„ user_agent_name

**æ›´æ”¹**: post_office.py ä¸­çº¦ 5-8 ä¸ªä½ç½®

**åŽç«¯æ€»æ›´æ”¹**: 4 ä¸ªæ–‡ä»¶ï¼Œçº¦ 15 ä¸ªä½ç½®

---

### ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯æ›´æ–°

#### 3.1 Web åº”ç”¨
- **æ–‡ä»¶**: `web/js/app.js`
  - ç¬¬ 79 è¡Œï¼šç”¨åŠ¨æ€ user agent åç§°æ›¿æ¢ `'User'` è¿‡æ»¤å™¨
  - ç¬¬ 202 è¡Œï¼šç”¨åŠ¨æ€æ£€æŸ¥æ›¿æ¢ `if (name === 'User')`
  - æ·»åŠ  `/api/config` ç«¯ç‚¹ä»¥èŽ·å– user_agent_name

**æ›´æ”¹**: 3 ä¸ªä½ç½® + 1 ä¸ªæ–° API ç«¯ç‚¹

#### 3.2 å®¢æˆ·ç«¯ HTML
- **æ–‡ä»¶**: `client.html`
  - ç¬¬ 161 è¡Œï¼šæ›´æ–°æ—¥å¿—ä»¥ä½¿ç”¨åŠ¨æ€åç§°

**æ›´æ”¹**: 1 ä¸ªä½ç½®

#### 3.3 æœåŠ¡å™¨ API æ‰©å±•
- **æ–‡ä»¶**: `server.py`
  - æ·»åŠ  `/api/config` ç«¯ç‚¹è¿”å›ž user_agent_name

**å‰ç«¯æ€»æ›´æ”¹**: 3 ä¸ªæ–‡ä»¶ï¼Œ4 ä¸ªä½ç½®ï¼Œ1 ä¸ªæ–°ç«¯ç‚¹

---

### ç¬¬å››é˜¶æ®µï¼šæ¨¡æ¿å’Œé…ç½®æ›´æ–°

#### 4.1 æ›´æ–°æ¨¡æ¿
- **æ–‡ä»¶**: `web/matrix_template/agents/User.yml`
  - å°† `name: User` æ”¹ä¸º `name: {{USER_AGENT_NAME}}` æˆ–ç±»ä¼¼
  - æˆ–ä½œä¸ºæ¸…æ™°å‘½åçš„ç¤ºä¾‹æä¾›

#### 4.2 æ›´æ–°æ–‡æ¡£
- **æ–‡ä»¶**: `profiles/prompts/base.txt`
  - ç¬¬ 82 è¡Œï¼šæ›´æ–°ç¤ºä¾‹ä»¥æ˜¾ç¤ºå¯é…ç½®çš„ user agent åç§°

#### 4.3 é…ç½®æ–‡ä»¶æ ¼å¼
- **æ–‡ä»¶**: æ·»åŠ åˆ° `matrix_world.yml` æ¨¡æ¿ï¼š
  ```yaml
  # User Agent Configuration
  user_agent_name: User  # æ›´æ”¹ä»¥è‡ªå®šä¹‰ï¼ˆä¾‹å¦‚ "Human", "Alice"ï¼‰
  ```

**æ¨¡æ¿æ€»æ›´æ”¹**: 3 ä¸ªæ–‡ä»¶

---

### ç¬¬äº”é˜¶æ®µï¼šéªŒè¯å’Œæµ‹è¯•

#### 5.1 æ·»åŠ éªŒè¯
- **æ–‡ä»¶**: `src/agentmatrix/core/loader.py`
  - æ·»åŠ éªŒè¯ï¼šåº”è¯¥æ°å¥½å­˜åœ¨ä¸€ä¸ª user proxy agent
  - å¦‚æžœæœªæ‰¾åˆ° user proxy agent åˆ™è­¦å‘Š
  - å¦‚æžœæ£€æµ‹åˆ°å¤šä¸ª user proxy agent åˆ™æŠ¥é”™

#### 5.2 è¿ç§»è„šæœ¬
- åˆ›å»ºè¿ç§»å®žç”¨ç¨‹åºä»¥ï¼š
  - æ›´æ–°çŽ°æœ‰ matrix_world.yml æ–‡ä»¶
  - è¿ç§»å…·æœ‰ç¡¬ç¼–ç  "User" å¼•ç”¨çš„æ•°æ®åº“è®°å½•
  - æä¾›å›žæ»šæœºåˆ¶

#### 5.3 æµ‹è¯•
- åŠ¨æ€åç§°è§£æžçš„å•å…ƒæµ‹è¯•
- CLIã€Web å’Œ API çš„é›†æˆæµ‹è¯•
- çŽ°æœ‰ä¸–ç•Œçš„è¿ç§»æµ‹è¯•
- å‘åŽå…¼å®¹æ€§éªŒè¯

---

## ðŸ”„ è¿ç§»ç­–ç•¥

### å‘åŽå…¼å®¹æ€§

1. **é»˜è®¤è¡Œä¸º**: å¦‚æžœæœªæŒ‡å®š `user_agent_name`ï¼Œé»˜è®¤ä¸º "User"
2. **æ•°æ®åº“è¿ç§»**: è„šæœ¬æ›´æ–°çŽ°æœ‰é‚®ä»¶è®°å½•
3. **ä¼˜é›…å›žé€€**: å¦‚æžœæœªæ‰¾åˆ° User agent åˆ™è­¦å‘Šä½†ç»§ç»­

### çŽ°æœ‰ç”¨æˆ·çš„è¿ç§»æ­¥éª¤

```bash
# 1. æ›´æ–°é…ç½®
cat >> matrix_world.yml << EOF
# User Agent Configuration
user_agent_name: "Human"  # æ‚¨çš„è‡ªå®šä¹‰åç§°
EOF

# 2. è¿è¡Œè¿ç§»è„šæœ¬
python scripts/migrate_user_agent.py --old-name "User" --new-name "Human"

# 3. é‡å¯æœåŠ¡å™¨
python server.py --matrix-world ./YourWorld --port 8000
```

---

## âš ï¸ é£Žé™©è¯„ä¼°

### é«˜é£Žé™©åŒºåŸŸ
1. **æ•°æ®åº“æŸ¥è¯¢** - å¿…é¡»åœ¨è¿ç§»æœŸé—´å¤„ç†æ—§åç§°å’Œæ–°åç§°
2. **WebSocket å›žè°ƒ** - å¦‚æžœé…ç½®é”™è¯¯ä¼šç ´åå®žæ—¶æ›´æ–°
3. **çŽ°æœ‰å¯¹è¯åŽ†å²** - éœ€è¦ä»”ç»†çš„æ•°æ®è¿ç§»

### ç¼“è§£ç­–ç•¥
1. å‘å¸ƒå‰è¿›è¡Œå……åˆ†æµ‹è¯•
2. å¸¦æœ‰éªŒè¯çš„è¿ç§»è„šæœ¬
3. å›žæ»šæœºåˆ¶
4. æ¸…æ™°çš„æ–‡æ¡£å’Œå¼ƒç”¨æœŸ

---

## ðŸ“Š å½±å“æ€»ç»“

| ç»„ä»¶ | éœ€æ›´æ”¹çš„æ–‡ä»¶ | æ›´æ”¹çš„è¡Œæ•° | é£Žé™©ç­‰çº§ |
|------|-------------|-----------|---------|
| åŽç«¯æ ¸å¿ƒ | 4 | ~50 | ä¸­ç­‰ |
| å‰ç«¯ | 3 | ~15 | ä½Ž |
| æ¨¡æ¿ | 3 | ~10 | ä½Ž |
| æ•°æ®åº“ | è¿ç§»è„šæœ¬ | N/A | é«˜ |
| æ–‡æ¡£ | å¤šä¸ª | ~20 | æ—  |
| **æ€»è®¡** | **13+** | **~95+** | **ä¸­ç­‰** |

---

## âœ… ç»“è®º

**å¯è¡Œæ€§**: âœ… **é«˜åº¦å¯è¡Œ**

**æŽ¨èæ–¹æ³•**: åŸºäºŽé…ç½®ï¼Œå‘åŽå…¼å®¹

**é¢„ä¼°å·¥ä½œé‡**:
- æ ¸å¿ƒå®žçŽ°: 2-3 å¤©
- æµ‹è¯•å’ŒéªŒè¯: 2-3 å¤©
- æ–‡æ¡£å’Œè¿ç§»å·¥å…·: 1-2 å¤©
- **æ€»è®¡**: çº¦ 1 å‘¨

**æ”¶ç›Š**:
- âœ… ä¸åŒç”¨ä¾‹çš„çµæ´»å‘½å
- âœ… æ›´å¥½çš„å›½é™…åŒ–æ”¯æŒ
- âœ… æ›´æ¸…æ™°çš„æž¶æž„
- âœ… ä¸ºå¤šç”¨æˆ·åœºæ™¯æœªæ¥-proof

è¿™ä¸ªæ›´æ”¹æ˜¯æž¶æž„æ€§çš„ï¼Œä½†èŒƒå›´æ˜Žç¡®ã€‚é€šè¿‡é€‚å½“çš„è§„åˆ’å’Œæµ‹è¯•ï¼Œå¯ä»¥å®‰å…¨åœ°å®žçŽ°ï¼Œå¯¹çŽ°æœ‰ç”¨æˆ·çš„æœ€å°ä¸­æ–­ã€‚

---

## ðŸ“š ç›¸å…³æ–‡ä»¶æ¸…å•

### éœ€è¦ä¿®æ”¹çš„æ ¸å¿ƒæ–‡ä»¶
1. `src/agentmatrix/core/runtime.py` - æ·»åŠ  user_agent_name å±žæ€§
2. `src/agentmatrix/core/loader.py` - æ·»åŠ éªŒè¯é€»è¾‘
3. `server.py` - é…ç½®åŠ è½½ã€API ç«¯ç‚¹ã€å›žè°ƒè®¾ç½®
4. `cli_runner.py` - åŠ¨æ€åç§°å¼•ç”¨
5. `src/agentmatrix/core/database.py` - å‚æ•°åŒ–æŸ¥è¯¢
6. `src/agentmatrix/core/post_office.py` - åŠ¨æ€åç§°æ¯”è¾ƒ
7. `web/js/app.js` - å‰ç«¯åŠ¨æ€åç§°å¤„ç†
8. `client.html` - UI æ›´æ–°

### éœ€è¦æ›´æ–°çš„æ¨¡æ¿
1. `web/matrix_template/agents/User.yml` - Agent æ¨¡æ¿
2. `profiles/prompts/base.txt` - Prompt æ¨¡æ¿
3. `web/matrix_template/agents/prompts/base.txt` - Web prompt æ¨¡æ¿

### éœ€è¦æ–°å»ºçš„æ–‡ä»¶
1. `src/agentmatrix/core/config.py` - é…ç½®ç®¡ç†ï¼ˆæˆ–é›†æˆåˆ°çŽ°æœ‰ï¼‰
2. `scripts/migrate_user_agent.py` - è¿ç§»è„šæœ¬
3. `docs/User Nameè¿ç§»æŒ‡å—.md` - ç”¨æˆ·è¿ç§»æ–‡æ¡£

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-05
**æœ€åŽæ›´æ–°**: 2025-01-05
