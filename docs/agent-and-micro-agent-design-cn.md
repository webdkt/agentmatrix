
# Agent 和 MicroAgent 设计

## 概述

### 为什么要分两层

做 Agent 时有个实际问题：**一次对话可能包含多个任务，而每个任务又要分多步执行。**

如果把这些混在一起，状态会很乱：对话历史、任务状态、执行步数……全堆在一起。

### 我们的方案：Agent（会话层）+ MicroAgent（执行层）

**Agent = 会话管理者**
- 管理对话历史和状态
- 拥有技能包（Skills）
- 创建 MicroAgent 执行任务

**MicroAgent = 任务执行者**
- 专门跑单个任务（思考-行动循环）
- 使用 Agent 的能力
- 有独立的工作上下文
- 任务完成就销毁

### 核心价值

1. **职责清晰**：对话管理 vs 任务执行
2. **状态隔离**：对话历史不被执行步骤污染
3. **递归嵌套**：MicroAgent 可以创建子 MicroAgent，支持任务层层分解
4. **失败不伤对话**：任务失败不影响会话

## 核心实体

### Agent（会话管理者）

长期运行的实体，负责管理会话和提供能力。

**核心职责**：
1. **身份和人格**：有自己的名字、描述、人设
2. **对话管理**：可以同时管理多个对话（sessions）
3. **对话记忆**：维护可持久化的状态记忆，自动保存
4. **Skills 和 Actions**：所有能力通过技能包（Skills）动态加载

**生命周期**：持续运行，处理多个对话

### MicroAgent（任务执行者）

临时执行者，专门跑单个任务。

**核心职责**：
1. **执行任务**：运行思考-行动循环
2. **使用能力**：使用 Agent 的 Skills 和 Actions
3. **工作空间**：可以有独立的工作目录
4. **独立上下文**：自己的任务描述、执行历史、步数计数

**生命周期**：创建 → 执行 → 销毁

**创建方式**：通过指定父级（parent）创建，自动获得所有能力

### 对话记忆（状态记忆）

智能的状态记忆，自动处理持久化。

**核心机制**：
1. **共享记忆**：Agent 创建后，所有 MicroAgent 通过层级链共享**同一份记忆**
2. **自动保存**：Agent 的对话记忆会自动保存，每次更新都会持久化到磁盘
3. **共享 vs 独立**：
   - 共享模式（默认）：使用父级的对话记忆
   - 独立模式：创建自己的独立记忆（不持久化）

**优势**：符合直觉（像公司员工用共享数据库）、自动化、灵活

### 工作空间

层级化的工作目录结构。

**核心机制**：
1. **层级目录**：根目录 → 子任务目录
2. **创建子目录**：
   - 带时间戳：适合独立任务，每次创建新目录
   - 不带时间戳：适合多轮任务，所有轮次共享同一目录
3. **隔离和共享**：MicroAgent 可以有独立目录，也可以共享父级的

## Skills 和 Actions

### Action（能力）

Action 是 Agent 能做的事情。

**例子**：
- 搜索网络信息
- 打开网页
- 读写文件
- 发送邮件
- 总结内容

### Skill（技能包）

Skill 是一组相关的能力集合，是可复用的能力模块。

**例子**：
- **网络搜索 Skill**：包含搜索、打开网页、提取内容等 Actions
- **文件操作 Skill**：包含读写、创建目录等 Actions
- **浏览器自动化 Skill**：包含点击、输入、滚动等 Actions

### Skills 如何配置

在 Agent 的配置文件中指定需要哪些技能包：

```
Agent 配置：
  名字：Researcher
  技能包：
    - 网络搜索
    - 文件操作
    - 浏览器自动化
```

### 能力如何加载和共享

运行时动态组合：
1. Agent 根据配置加载多个技能包
2. 技能包中的所有 Actions 注册到能力表
3. 所有 MicroAgent 通过层级链共享这些 Actions
4. 任何层级都可以调用任何 Action

**优势**：
- 模块化：每个技能包独立
- 可复用：同一个技能包可被多个 Agent 使用
- 动态组合：灵活配置能力

## MicroAgent 执行机制

### 核心：每次执行都是"新的灵魂"

虽然 MicroAgent 类是同一个，但**每次执行都是全新的实例**，就像同一个演员扮演不同的角色。

### 能力继承（从 Agent 获得）

创建 MicroAgent 时，通过指定父级自动获得 Agent 的所有能力：
- 所有可用的 Actions
- 推理能力和参数解析能力
- 对话记忆（共享引用）
- 日志系统

### 灵魂注入（每次执行时动态注入）

这是让同一个 MicroAgent 类能够执行不同任务的关键。

**注入的三要素**：

1. **人设（System Prompt）**
   - 这次执行时的身份和人格
   - 比如："你是网络搜索专家"或"你是文件整理助手"
   - 决定了执行者的思考方式和行为风格

2. **任务（初始 User Message）**
   - 具体要做什么
   - 比如："帮我搜索 AI 安全的最新论文"
   - 或："整理当前目录下的所有文件"

3. **可用能力列表**
   - 这次执行允许使用哪些 Actions
   - 可能是全部能力，也可能是子集
   - 比如：
     - 全部：["搜索", "打开网页", "读写文件", "发送邮件"]
     - 限制：["搜索", "打开网页"]（不允许发送邮件）

**为什么需要限制可用能力**：
- 让执行者更专注
- 避免执行者误用不该用的能力
- 不同的任务需要不同的工具集

### 执行流程

```
1. 创建 MicroAgent（父级 = Agent）
   └─ 获得：所有 Actions、推理能力、对话记忆

2. 注入灵魂（每次执行）：
   ├─ 人设："你是网络搜索专家"
   ├─ 任务："搜索 AI 安全的论文"
   └─ 可用能力：["搜索", "打开网页"]

3. 执行任务（思考-行动循环）：
   ├─ 思考：下一步该做什么
   ├─ 选择：从可用能力中选择一个
   ├─ 行动：执行选中的能力
   └─ 重复：直到任务完成

4. 返回结果
   └─ 销毁
```

### 类比说明

就像同一个演员：
- **MicroAgent 类**：演员本人
- **灵魂注入**：给他不同的剧本、服装、道具
- **人设**：扮演的角色（医生、律师、老师）
- **任务**：剧情要求做的事情
- **可用能力**：这场戏允许他使用的道具

观众看到的是完全不同的角色，而不是同一个演员。

## 能力传递机制

### 层级链

每个 MicroAgent 都有一个父级引用，形成一条链：

```
Agent（没有父级）
  ↑ 父级
  │
MicroAgent 第 1 层
  ↑ 父级
  │
MicroAgent 第 2 层
```

### 自动传递的组件

创建 MicroAgent 时，只需指定父级：

```
创建 MicroAgent（父级 = Agent）
```

自动获得：
- **所有 Actions**：Agent 注册的所有能力
- **推理能力**：用于思考和决策
- **参数解析能力**：用于理解 Action 需要什么参数
- **对话记忆**：通过共享引用
- **日志系统**：记录执行过程

### 追溯到根 Agent

任何 MicroAgent 都可以追溯到最初的 Agent：

```
this.root_agent  # Agent 实例
```



## 递归嵌套

### "自然语言函数"概念

把执行 MicroAgent 看作自然语言函数：
- **输入**：自然语言任务描述
- **处理**：AI 推理 + 多步思考-行动循环
- **输出**：自然语言结果或结构化数据

### 嵌套示例

```
用户任务："研究 AI 安全"

Agent
  └─ MicroAgent（第 1 层）
      人设："研究规划师"
      任务："制定研究计划"
      可用能力：全部 Actions

      │
      ├─ 创建子 MicroAgent（第 2 层）
      │   人设："网络搜索专家"
      │   任务："搜索相关论文"
      │   可用能力：["搜索", "打开网页"]
      │
      │   └─ 创建子 MicroAgent（第 3 层）
      │       人设："内容分析师"
      │       任务："分析搜索结果"
      │       可用能力：["总结", "提取信息"]
      │
      │       └─ 返回分析结果
      │
      └─ 整合结果，生成报告
```

**关键**：
- 每层都有独立的"灵魂"（人设、任务、可用能力）
- 第 3 层的分析不会污染第 2 层的上下文
- 每层只看到下层的最终结果

## 通信和协作

### 基于邮件的通信

Agent 间使用邮件数据结构：
- 发送者/接收者
- 自然语言正文
- 回复关系（维护对话线程）
- 用户会话跟踪

### 邮局系统

提供：
- **服务注册**：哪些 Agent 在线
- **消息路由**：把邮件送到正确的接收者
- **异步通信**：非阻塞的消息传递

### 自然语言协调

```
规划者 → 研究者: "请帮我研究一下 AI 安全"
研究者 → 规划者: "我找到了 5 篇重要论文..."
```

**优势**：可解释、易调试、符合人类协作习惯
